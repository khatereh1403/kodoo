
/* /knowledge/static/src/js/wysiwyg.js */
odoo.define('@knowledge/js/wysiwyg',['@odoo/owl','@web/core/utils/render','@web_editor/js/wysiwyg/wysiwyg','@knowledge/components/prompt_embedded_view_name_dialog/prompt_embedded_view_name_dialog','@web_editor/js/editor/odoo-editor/src/utils/utils','@knowledge/components/video_selector_dialog/video_selector_dialog','@knowledge/components/behaviors/article_behavior_dialog/article_behavior_dialog','@knowledge/js/knowledge_utils','@web/core/utils/patch','@web/core/l10n/translation','@knowledge/components/media_dialog/knowledge_media_dialog'],function(require){'use strict';let __exports={};const{Component}=require('@odoo/owl');const{renderToElement}=require("@web/core/utils/render");const{Wysiwyg}=require('@web_editor/js/wysiwyg/wysiwyg');const{PromptEmbeddedViewNameDialog}=require('@knowledge/components/prompt_embedded_view_name_dialog/prompt_embedded_view_name_dialog');const{isSelectionInSelectors,preserveCursor,setCursorEnd,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const{VideoSelectorDialog}=require('@knowledge/components/video_selector_dialog/video_selector_dialog');const{ArticleSelectionBehaviorDialog}=require('@knowledge/components/behaviors/article_behavior_dialog/article_behavior_dialog');const{encodeDataBehaviorProps,}=require("@knowledge/js/knowledge_utils");const{patch}=require("@web/core/utils/patch");const{_t}=require("@web/core/l10n/translation");const{KnowledgeMediaDialog}=require('@knowledge/components/media_dialog/knowledge_media_dialog');patch(Wysiwyg.prototype,{async resetEditor(){await super.resetEditor(...arguments);this.$editable[0].dispatchEvent(new Event('mount_knowledge_behaviors'));},_getEditorOptions(){const finalOptions=super._getEditorOptions(...arguments);const onHistoryResetFromSteps=finalOptions.onHistoryResetFromSteps;finalOptions.onHistoryResetFromSteps=()=>{onHistoryResetFromSteps();if(this._onHistoryResetFromSteps){this._onHistoryResetFromSteps();}};return{allowCommandFile:true,...finalOptions,};},_getPowerboxOptions(){const options=super._getPowerboxOptions();const{commands,categories}=options;categories.push({name:_t('Media'),priority:50});commands.push({category:_t('Media'),name:_t('Article'),priority:10,description:_t('Link an article'),fontawesome:'fa-file',isDisabled:()=>this.options.isWebsite||this.options.inIframe,callback:()=>{this._insertArticleLink();},});if(this.options.knowledgeCommands){categories.push({name:_t('Knowledge'),priority:11},{name:_t('Knowledge Databases'),priority:10});commands.push({category:_t('Knowledge'),name:_t('File'),priority:20,description:_t('Upload a file'),fontawesome:'fa-file',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor')||!this.options.allowCommandFile,callback:()=>{this.openMediaDialog({noVideos:true,noImages:true,noIcons:true,noDocuments:true,MediaDialog:KnowledgeMediaDialog,});}},{category:_t('Knowledge'),name:_t('Clipboard'),priority:10,description:_t('Add a clipboard section'),fontawesome:'fa-pencil-square',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor'),callback:()=>{this._insertTemplate();},},{category:_t('Knowledge'),name:_t('Table Of Content'),priority:30,description:_t('Highlight the structure of this article'),fontawesome:'fa-bookmark',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor, table'),callback:()=>{this._insertTableOfContent();},},{category:_t('Knowledge Databases'),name:_t('Item Kanban'),priority:40,description:_t('Insert a Kanban view of article items'),fontawesome:'fa-th-large',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor, .o_editor_banner, table'),callback:()=>{const restoreSelection=preserveCursor(this.odooEditor.document);const viewType='kanban';this._openEmbeddedViewDialog(viewType,async(name)=>{await this.orm.call('knowledge.article','create_default_item_stages',[[this.options.recordInfo.res_id]],);this._insertEmbeddedView('knowledge.knowledge_article_item_action_stages',undefined,viewType,name,restoreSelection,{active_id:this.options.recordInfo.res_id,default_parent_id:this.options.recordInfo.res_id,default_is_article_item:true,});},restoreSelection);}},{category:_t('Knowledge Databases'),name:_t('Item Cards'),priority:39,description:_t('Insert a Card view of article items'),fontawesome:'fa-address-card',isDisabled:()=>isSelectionInSelectors('.o_editor_banner, .o_knowledge_behavior_anchor, table'),callback:()=>{const restoreSelection=preserveCursor(this.odooEditor.document);const viewType='kanban';this._openEmbeddedViewDialog(viewType,name=>{this._insertEmbeddedView('knowledge.knowledge_article_item_action',undefined,viewType,name,restoreSelection,{active_id:this.options.recordInfo.res_id,default_parent_id:this.options.recordInfo.res_id,default_is_article_item:true,});},restoreSelection);}},{category:_t('Knowledge Databases'),name:_t('Item List'),priority:50,description:_t('Insert a List view of article items'),fontawesome:'fa-th-list',isDisabled:()=>isSelectionInSelectors('.o_editor_banner, .o_knowledge_behavior_anchor, table'),callback:()=>{const restoreSelection=preserveCursor(this.odooEditor.document);const viewType='list';this._openEmbeddedViewDialog(viewType,name=>{this._insertEmbeddedView('knowledge.knowledge_article_item_action',undefined,viewType,name,restoreSelection,{active_id:this.options.recordInfo.res_id,default_parent_id:this.options.recordInfo.res_id,default_is_article_item:true,});},restoreSelection);}},{category:_t('Knowledge Databases'),name:_t('Item Calendar'),priority:29,description:_t('Insert a Calendar view of article items'),fontawesome:'fa-calendar-plus-o',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor, table'),callback:this._insertItemCalendar.bind(this),},{category:_t('Knowledge'),name:_t('Index'),priority:60,description:_t('Show nested articles'),fontawesome:'fa-list',isDisabled:()=>isSelectionInSelectors('.o_knowledge_behavior_anchor, table'),callback:()=>{this._insertArticlesStructure(false);}},{category:_t('Media'),name:_t('Video'),priority:70,description:_t('Insert a Video'),fontawesome:'fa-play',callback:()=>{const restoreSelection=preserveCursor(this.odooEditor.document);this._openVideoSelectorDialog(media=>{this._insertVideo(media,restoreSelection);});}});}
return{...options,commands,categories};},_hasICEServers(){return true;},_notifyNewBehavior(anchor,restoreSelection,insert=null){const type=Array.from(anchor.classList).find(className=>className.startsWith('o_knowledge_behavior_type_'));this.$editable[0].dispatchEvent(new CustomEvent('mount_knowledge_behaviors',{detail:{behaviorData:{anchor,behaviorType:type,shouldSetCursor:true,restoreSelection,behaviorStatus:'new',insert,}}}));},_insertTableOfContent:function(){const restoreSelection=preserveCursor(this.odooEditor.document);const tableOfContentBlock=renderToElement('knowledge.AbstractBehaviorBlueprint',{behaviorType:"o_knowledge_behavior_type_toc",});this._notifyNewBehavior(tableOfContentBlock,restoreSelection);},_insertArticlesStructure:function(){const restoreSelection=preserveCursor(this.odooEditor.document);const articlesStructureBlock=renderToElement('knowledge.ArticlesStructureBehaviorBlueprint');this._notifyNewBehavior(articlesStructureBlock,restoreSelection);},_insertTemplate(){const restoreSelection=preserveCursor(this.odooEditor.document);const templateBlock=renderToElement('knowledge.AbstractBehaviorBlueprint',{behaviorType:"o_knowledge_behavior_type_template",});this._notifyNewBehavior(templateBlock,restoreSelection);},_insertArticleLink:function(){const restoreSelection=preserveCursor(this.odooEditor.document);Component.env.services.dialog.add(ArticleSelectionBehaviorDialog,{title:_t('Link an Article'),confirmLabel:_t('Insert Link'),articleSelected:article=>{const articleLinkBlock=renderToElement('knowledge.ArticleBehaviorBlueprint',{href:'/knowledge/article/'+article.articleId,data:encodeDataBehaviorProps({article_id:article.articleId,display_name:article.displayName,}),});const nameNode=document.createTextNode(article.display_name);articleLinkBlock.appendChild(nameNode);this._notifyNewBehavior(articleLinkBlock,restoreSelection);},parentArticleId:this.options.recordInfo.res_model==='knowledge.article'?this.options.recordInfo.res_id:undefined},{onClose:()=>{restoreSelection();}});},_insertEmbeddedView:async function(actWindowXMLId,actWindowObject,viewType,name,restoreSelection,context={},additionalViewProps=undefined){const actionWindow=actWindowXMLId?{action_xml_id:actWindowXMLId}:{act_window:actWindowObject};const props={...actionWindow,display_name:name,view_type:viewType,context,};if(additionalViewProps){props.additionalViewProps=additionalViewProps;}
const behaviorProps=encodeDataBehaviorProps(props);const embeddedViewBlock=renderToElement('knowledge.EmbeddedViewBehaviorBlueprint',{behaviorProps,action_help:actionWindow.act_window?.help,});this._notifyNewBehavior(embeddedViewBlock,restoreSelection);this.env.model.root.update({'full_width':true});},_insertVideo:function(media,restoreSelection){const videoBlock=renderToElement('knowledge.VideoBehaviorBlueprint',{behaviorProps:encodeDataBehaviorProps({videoId:media.videoId,platform:media.platform,params:media.params||{}})});this._notifyNewBehavior(videoBlock,restoreSelection);},appendBehaviorBlueprint(behaviorBlueprint){const restoreSelection=()=>{return setCursorEnd(this.odooEditor.editable,false);}
const insert=(anchor)=>{const fragment=this.odooEditor.document.createDocumentFragment();const p=this.odooEditor.document.createElement('p');p.append(this.odooEditor.document.createElement('br'));fragment.append(anchor,p);const insertedNodes=this.odooEditor.execCommand('insert',fragment);if(insertedNodes){insertedNodes[0].scrollIntoView();return insertedNodes;}};this._notifyNewBehavior(behaviorBlueprint.cloneNode(true),restoreSelection,(anchor)=>{const insertedNodes=insert(anchor);this._onHistoryResetFromSteps=()=>{this._notifyNewBehavior(behaviorBlueprint.cloneNode(true),restoreSelection,insert);this._onHistoryResetFromSteps=undefined;};return insertedNodes;});if(behaviorBlueprint.classList.contains('o_knowledge_behavior_type_embedded_view')){this.env.model.root.update({'full_width':true});}},_onMediaDialogSave(params,element){if(!element?.querySelector('.o_knowledge_behavior_anchor')){return super._onMediaDialogSave(...arguments);}
params.restoreSelection();this._notifyNewBehavior(element,params.restoreSelection);},_openEmbeddedViewDialog:function(viewType,save,onClose){Component.env.services.dialog.add(PromptEmbeddedViewNameDialog,{isNew:true,viewType:viewType,save:save},{onClose:onClose||(()=>{}),});},_insertItemCalendar:function(){const{ItemCalendarPropsDialog}=odoo.loader.modules.get("@knowledge/components/item_calendar_props_dialog/item_calendar_props_dialog");const restoreSelection=preserveCursor(this.odooEditor.document);Component.env.services.dialog.add(ItemCalendarPropsDialog,{isNew:true,knowledgeArticleId:this.options.recordInfo.res_id,saveItemCalendarProps:(name,itemCalendarProps)=>{this._insertEmbeddedView('knowledge.knowledge_article_action_item_calendar',undefined,'calendar',name,restoreSelection,{active_id:this.options.recordInfo.res_id,default_parent_id:this.options.recordInfo.res_id,default_icon:'📄',default_is_article_item:true,},{itemCalendarProps,});}},{onClose:()=>{restoreSelection();}});},_openVideoSelectorDialog:function(save){Component.env.services.dialog.add(VideoSelectorDialog,{save});}});return __exports;});;

/* /knowledge/static/src/js/knowledge_wysiwyg.js */
odoo.define('@knowledge/js/knowledge_wysiwyg',['@web/core/l10n/translation','@web_editor/js/editor/odoo-editor/src/OdooEditor','@web_editor/js/wysiwyg/wysiwyg','@web/core/utils/hooks','@web_editor/js/editor/odoo-editor/src/utils/utils','@web_editor/js/wysiwyg/widgets/chatgpt_prompt_dialog','@odoo/owl'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{isEmptyBlock}=require("@web_editor/js/editor/odoo-editor/src/OdooEditor");const{Wysiwyg}=require("@web_editor/js/wysiwyg/wysiwyg");const{useBus}=require('@web/core/utils/hooks');const{isZWS,getDeepRange,getSelectedNodes,closestElement,}=require("@web_editor/js/editor/odoo-editor/src/utils/utils");const{ChatGPTPromptDialog}=require('@web_editor/js/wysiwyg/widgets/chatgpt_prompt_dialog');const{useRef}=require('@odoo/owl');const KnowledgeWysiwyg=__exports.KnowledgeWysiwyg=class KnowledgeWysiwyg extends Wysiwyg{static template='knowledge.KnowledgeWysiwyg';setup(){super.setup(...arguments);useBus(this.env.bus,'KNOWLEDGE_WYSIWYG:HISTORY_STEP',()=>this.odooEditor.historyStep());this.knowledgeCommentsToolbarBtnRef=useRef('knowledgeCommentsToolbarBtn');}
generateArticle(){this.env.services.dialog.add(ChatGPTPromptDialog,{initialPrompt:_t('Write an article about'),insert:(content)=>{const generatedContentTitle=content.querySelector('h1,h2');const articleTitle=document.createElement('h1');if(generatedContentTitle&&generatedContentTitle.tagName!=='H1'){articleTitle.innerText=generatedContentTitle.innerText;generatedContentTitle.replaceWith(articleTitle);}else if(!generatedContentTitle){articleTitle.innerHTML='<br>';content.prepend(articleTitle);}
const divElement=document.createElement('div');divElement.appendChild(content);this.odooEditor.resetContent(divElement.innerHTML);}});}
_configureToolbar(options){this.knowledgeCommentsToolbarBtnRef.el?.addEventListener('click',()=>{getDeepRange(this.$editable[0],{splitText:true,select:true,correctTripleClick:true});const selectedNodes=getSelectedNodes(this.$editable[0]).filter(selectedNode=>selectedNode.nodeType===Node.TEXT_NODE&&closestElement(selectedNode).isContentEditable);this.env.bus.trigger('KNOWLEDGE:CREATE_COMMENT_THREAD',{selectedNodes});});super._configureToolbar(...arguments);}
_onSelectionChange(){const selection=document.getSelection();if(selection.type==="None"){super._onSelectionChange(...arguments);return;}
const selectedNodes=getSelectedNodes(this.$editable[0]);const btnHidden=selectedNodes.length&&selectedNodes.every((node)=>isZWS(node)||!closestElement(node)?.isContentEditable);this.knowledgeCommentsToolbarBtnRef.el?.classList.toggle('d-none',btnHidden);super._onSelectionChange(...arguments);}
async startEdition(){await super.startEdition(...arguments);this.odooEditor.options.renderingClasses=[...this.odooEditor.options.renderingClasses,'focused-comment'];}
isEmpty(){return this.$editable[0].children.length===1&&isEmptyBlock(this.$editable[0].firstElementChild);}}
return __exports;});;

/* /knowledge/static/src/js/knowledge_clipboard_whitelist.js */
odoo.define('@knowledge/js/knowledge_clipboard_whitelist',['@web_editor/js/editor/odoo-editor/src/OdooEditor'],function(require){'use strict';let __exports={};const{CLIPBOARD_WHITELISTS}=require('@web_editor/js/editor/odoo-editor/src/OdooEditor');CLIPBOARD_WHITELISTS.classes.push(/^o_knowledge_/);return __exports;});

                    /*******************************************
                    *  Templates                               *
                    *******************************************/

                    odoo.define('knowledge.assets_wysiwyg.bundle.xml', ['@web/core/registry'], function(require){
                        'use strict';
                        const { registry } = require('@web/core/registry');
                        registry.category(`xml_templates`).add(`knowledge.assets_wysiwyg`, `<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
<t t-name="knowledge.AbstractBehaviorBlueprint">
        <div t-attf-class="o_knowledge_behavior_anchor #{behaviorType}" data-oe-protected="true"/>
    </t>
    <t t-name="knowledge.ArticleBehaviorBlueprint">
        <a t-att-href="href" t-att-data-behavior-props="data" target="_blank" class="btn btn-sm o_knowledge_behavior_anchor o_knowledge_behavior_type_article" data-oe-protected="true"/>
    </t>
    <t t-name="knowledge.VideoBehaviorBlueprint">
        <div class="o_knowledge_behavior_anchor o_knowledge_behavior_type_video" t-att-data-behavior-props="behaviorProps" data-oe-protected="true"/>
    </t>
    <t t-name="knowledge.ArticlesStructureBehaviorBlueprint">
        <div class="o_knowledge_behavior_anchor o_knowledge_behavior_type_articles_structure" data-oe-protected="true"/>
    </t>
    <t t-name="knowledge.EmbeddedViewBehaviorBlueprint">
        <div class="o_knowledge_behavior_anchor o_knowledge_behavior_type_embedded_view" t-att-data-behavior-props="behaviorProps" data-oe-protected="true">
            <div t-if="action_help" class="o_knowledge_content d-none" data-prop-name="action_help">
                <t t-out="action_help"/>
            </div>
        </div>
    </t>
    <t t-name="knowledge.EmbeddedViewLinkBehaviorBlueprint">
        <span class="o_knowledge_view_link text-o-color-1 o_knowledge_behavior_anchor o_knowledge_behavior_type_view_link" t-att-data-behavior-props="behaviorProps" data-oe-protected="true"/>
    </t>
    <t t-name="knowledge.FileBehaviorBlueprint">
        <div class="o_knowledge_behavior_anchor o_knowledge_behavior_type_file" t-att-data-behavior-props="behaviorProps" data-oe-protected="true"/>
    </t>
<t t-name="knowledge.article_item_template">
        <h1 t-out="title"/>
        <div class="o_knowledge_behavior_anchor o_knowledge_behavior_type_embedded_view" t-att-data-behavior-props="behaviorProps" data-oe-protected="true"/>
        <p><br/></p>
    </t>

</templates>`);
                    });